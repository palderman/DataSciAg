---
title: "Programming with Data - Iteration"
author: |
  | Data Science for Agriculture and Natural Resources
  | PLNT 5413 - Fall `r format(Sys.Date(),'%Y')`
output: pdf_document
link-citations: true
urlcolor: blue
margin: 1in
fontsize: 12pt
geometry: "left=1in,right=1in,top=1in,bottom=1.25in"
header-includes:
  - \usepackage{titling}
  - \usepackage{lastpage}
  - \usepackage{fancyhdr}
  - \newcommand{\aspace}[1]{\vspace{#1\baselineskip}}
  - \renewcommand{\headrulewidth}{0pt}
  - \fancypagestyle{plain}{ \fancyhf{} \fancyfoot[C]{\aspace{2}Page     \thepage~of~\pageref{LastPage}} }
  - \pagestyle{fancy}
  - \fancyhf{}
  - \fancyfoot[C]{\small \thetitle \\ Data Science for Agriculture and Natural Resources\\PLNT 5413 - Fall `r format(Sys.Date(),'%Y')`\\ Page \thepage~of~\pageref{LastPage}}
---

```{r setup,echo=FALSE}
knitr::opts_chunk$set(echo=FALSE, include=TRUE)
```

```{r program_assignment_code,echo=FALSE,include=FALSE}
library(tidyverse)
list_forest_divisions <- function(path){

  for_div_list <- list.files(path = path) %>% # list all files in the path directory
    str_replace_all('(.*/)|(_.*)','') %>% # Strip off any leading directories and trailing file extenstions including _tree_data or _site_data labels
    unique() # Remove duplicate entries in resulting list
  
  return(for_div_list)
}
read_forest_division <- function(directory,for_div){

  tree_data <- paste0(directory,'/',for_div,'_tree_data.txt') %>% # Combine directory path and forest division to create tree data file name
    read_tsv(na = "0",                                  # Read tree data setting "0" observations to NA
             col_types = cols(PlotID = col_character(), # Specifying column types
                              SpCode = col_character(),
                              TreeGirth1 = col_double(),
                              TreeGirth2 = col_double(),
                              TreeGirth3 = col_double(),
                              TreeGirth4 = col_double(),
                              TreeGirth5 = col_double()))
  
  site_data <- paste0(directory,'/',for_div,'_site_data.txt') %>% # Combine directory path and forest division to create site data file name
    read_tsv(col_types = cols_only(PlotID = col_character(),      # Read site data selecting columns and specifying column types
                                   LatDec = col_double(),
                                   LongDec = col_double(),
                                   Alt = col_double(),
                                   Rain = col_double()))

  combined_data <- right_join(site_data,tree_data,by='PlotID') %>% # Join site data and tree data
    mutate(ForestDiv=for_div)                       # Add column for forest division
  
  return(combined_data)   # Return combined data
}

```

This assignment builds on the `Programming with Data - Defining Functions` assignment.

1. Revise the function you created previously called `read_forest_division()` so that it:
    * Takes a data directory path and a forest division name as arguments
    * Converts the path and forest division name into file path and names for tree and site data files
    * Reads tree data into a tibble and marks '0' tree girth observations as missing (i.e.`NA`)
    * Reads the site data into a tibble while using the `col_types` argument to read only the plot ID, latitude, longitude, altitude, and rain columns
    * Joins the tree and site data tibbles into a single tibble
    * Returns the resulting tibble

```{r problem_2_output,echo=FALSE,include=TRUE}
for_divs <- list_forest_divisions('data')
cat(paste0('Example output for ',for_divs[1],'\n'))
for_div_1 <- read_forest_division('data',for_divs[1])
for_div_1
```

2. Write a new function called `read_all_divisions()` that:
    * Takes a data directory path as an argument
    * Calls the `list_forest_divisions()` function to generate a list of forest divisions
    * Calls the `read_forest_division()` function for each element of the list generated by the `list_forest_divisions()` function and capturing the output into a single object
    * Converts the object generated by the calls to `read_forest_division()` into a single tibble
    * Gathers the tree girth data into a single column, removes missing observations, and returns the resulting tibble

```{r problem_3_code}
read_all_divisions <- function(path){
  # Load required packages
  require(tidyverse)
  
  all_data <- list_forest_divisions(path) %>% # Generate list of forest divisions
    map(read_forest_division,   # Iterate reading data over each forest division
        directory = path) %>% 
    bind_rows() %>%             # Combine all forest division data into single tibble
    gather('tree','girth',TreeGirth1:TreeGirth5) %>% # Gather tree girth data into a single column
    drop_na()  # Drop missing observations

  return(all_data) # Return 
}

```

```{r problem_3_output,echo=FALSE,include=TRUE}
all_data <- read_all_divisions('data')
all_data
```
