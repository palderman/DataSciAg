---
title: 'Exploring Data Assignment'
author: |
  | Data Science for Agriculture and Natural Resources
  | PLNT 5413 - Fall `r format(Sys.Date(),'%Y')`
output: pdf_document
link-citations: true
margin: 1in
fontsize: 12pt
geometry: "left=1in,right=1in,top=1in,bottom=1.25in"
header-includes:
- \usepackage{titling}
- \usepackage{lastpage}
- \usepackage{fancyhdr}
- \newcommand{\aspace}[1]{\vspace{#1\baselineskip}}
- \renewcommand{\headrulewidth}{0pt}
- \fancypagestyle{plain}{ \fancyhf{} \fancyfoot[C]{\aspace{2}Page \thepage~of~\pageref{LastPage}} }
- \pagestyle{fancy}
- \fancyhf{}
- \fancyfoot[C]{\small \thetitle \\ Data Science for Agriculture and Natural Resources\\PLNT 5413 - Fall `r format(Sys.Date(),'%Y')`\\ Page \thepage~of~\pageref{LastPage}}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

## Data Transformation

Load the `agridat` package and, using the `engelstad.nitro` dataset, create 5 separate data transformation pipelines that provide:

1. The yields for the 0 nitrogen treatment for each location and year.
2. The yields for the 335 nitrogen treatment for each location and year in order from lowest to highest yield.
3. The mean yield for each combination of location and year.
4. The mean yield for each level of nitrogen fertilizer.
5. The mean partial factor productivity (the yield divided by the nitrogen fertilizer applied) for each nitrogen fertilizer level.

```{r echo=FALSE,include=TRUE}
library(tidyverse)
library(agridat)

# Problem 1

engelstad.nitro %>%
  filter(nitro==0) %>%
  select(loc,year,yield)

# Problem 2

engelstad.nitro %>%
  filter(nitro==335) %>%
  select(loc,year,yield) %>%
  arrange(yield)

# Problem 3

engelstad.nitro %>%
  group_by(loc,year) %>%
  summarize(yield=mean(yield))

# Problem 4

engelstad.nitro %>%
  group_by(nitro) %>%
  summarize(yield=mean(yield))

# Problem 5

engelstad.nitro %>%
  filter(nitro>0) %>%
  mutate(PFP=yield/nitro) %>%
  group_by(nitro) %>%
  summarize(PFP=mean(PFP))
```


## Data Visualization

Load the `agridat` package and use the `diggle.cow` dataset with `ggplot()` to generate the following plots:

1. A scatterplot of weight over time

2. A boxplot of weight for each day of measurement

3. A boxplot of the final weights for each treatment

4. A multi-panel line plot of weight over time for each animal within each treatment group

5. A single-panel line plot of weight over time averaged within each treatment group and date of measurement

```{r}
library(agridat)

# Problem 1
diggle.cow %>% 
  ggplot(aes(x = day, y = weight)) +
  geom_point()

# Problem 2
diggle.cow %>% 
  ggplot(aes(x = day, y = weight, group = day)) +
  geom_boxplot()

# Problem 3
diggle.cow %>% 
filter(day==781) %>%
ggplot(aes(x = interaction(iron,infect),
           y = weight,
           group = interaction(iron,infect))) +
  geom_boxplot()

# Problem 4
diggle.cow %>% 
ggplot(aes(x = day, y = weight, group = animal)) +
  geom_line() +
  facet_grid(iron~infect)

# Problem 5
diggle.cow %>%
  group_by(iron,infect,day) %>%
  summarize(weight=mean(weight,na.rm=TRUE)) %>%
  ggplot(aes(x=day,y=weight,color=interaction(iron,infect))) +
    geom_line()

```


## Exploratory Data Analysis

Load the `agridat` package. This exercise will use data from the `steptoe.morex.pheno` data set. For this data set we are interested in understanding the relationship between genotype and heading date (`hddate`).

1. Start by generating a histogram of `hddate` using a `binwidth` of 1.

2. These results look good, but there seem to be a few places in the histogram that might indicate that the distribution might be mixed. Nevertheless, we decide to look at how `hddate` varies across genotypes. Generate a boxplot that shows the distribution of `hddate` within each genotype and ordered by the median. Flip the coordinates so that `gen` is displayed on the y-axis.

3. These results indicate there might be a trend across genotypes, but the distributions for each genotype overlap a lot. Because we know that heading date is strongly influenced by temperature (something which would vary across location and year), we suspect that the trend across genotypes might be masked by the environment effect. To investigate this hypothesis, generate a frequency polygon plot with `hddate` grouped by `env`.

4. This shows promise, but it's hard to distinguish some of the environments with the previous plot. Generate a boxplot that shows the distribution of `hddate` within each `env` and orderd by median. Flip the coordinates so that `env` is displayed on the y-axis.

5. Those results do indicate an effect by `env` on `hddate`. Use `lm()` and `add_residuals()` from the `modelr` package to fit a linear model of `hddate` as a function of `env` and create a new data frame by combining the model residuals with the original data set. Then create a boxplot 
that shows the distribution of the model residuals within each genotype and ordered by the median. There seem to be a couple of outliers that make it harder to see the boxplots so restrict the axis to -15 to 15. Flip the coordinates so that `gen` is displayed on the y-axis.

```{r include=TRUE}
library(agridat)

# Problem 1
steptoe.morex.pheno %>% 
  ggplot(aes(x=hddate)) + 
  geom_histogram(binwidth=1)

# Problem 2
steptoe.morex.pheno %>% 
  ggplot(aes(x = reorder(gen,hddate,FUN=median),
             y = hddate)) + 
  geom_boxplot() +
  coord_flip()

# Problem 3
steptoe.morex.pheno %>% 
  ggplot(aes(x=hddate)) + 
  geom_freqpoly(aes(color=env))

# Problem 4
steptoe.morex.pheno %>% 
  ggplot(aes(x = reorder(env, hddate, FUN=median),
             y = hddate)) +
  geom_boxplot()+
  coord_flip()

# Problem 5

library(modelr)

mod <- lm(hddate~env,data=steptoe.morex.pheno)

steptoe.morex.pheno.resid <- steptoe.morex.pheno %>%
  add_residuals(mod)

steptoe.morex.pheno.resid %>% 
  ggplot(aes(x = reorder(gen, resid, FUN=median),
             y = resid)) +
  geom_boxplot() +
  coord_flip(ylim=c(-15,15))
```

